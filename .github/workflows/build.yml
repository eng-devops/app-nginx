# Pipeline BUILD: imagem Docker + Helm package (app-version e version no momento do package)
# Triggers: push | pull_request em main, develop, feature/*, release/*
# Versionamento: tag Git só na branch release/*. develop usa última tag; main usa versão final (última -rc sem sufixo).
# Bump (apenas em release): Feat!: -> major | Feat: -> minor | Fix: -> patch. RC com contador: v0.1.0-rc, v0.1.0-rc.1...

name: Build

on:
  push:
    branches:
      - 'feature/*'
      - 'release/*'
      - develop
      - main

env:
  REGISTRY: ghcr.io
  HELM_TEMPLATES_REPO: eng-devops/helm-templates
  CHART_APP: nginx

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    # Não executar quando a branch for excluída (push com deleted: true)
    if: github.event.deleted != true
    permissions:
      contents: write   # read + write para criar tag no repo
      packages: write

    steps:
      - name: Checkout Repos
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # histórico completo para cálculo de semver e tags

      - name: Checkout helm-templates
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HELM_TEMPLATES_REPO }}
          path: helm-templates
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determined Environment
        id: set-env
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then ENV="prd"
          elif [[ "$BRANCH" == "develop" ]]; then ENV="prd"
          elif [[ "$BRANCH" =~ ^release/ ]]; then ENV="stg"
          elif [[ "$BRANCH" =~ ^feature/ ]]; then ENV="dev"
          else ENV="dev"; fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "namespace=$ENV" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH -> $ENV"

      - name: Compute semantic version
        id: semver
        if: github.ref_name == 'main' || github.ref_name == 'develop' || startsWith(github.ref_name, 'release/')
        run: |
          BRANCH="${{ github.ref_name }}"
          VERSION=$(bash .github/scripts/semver.sh "$BRANCH" || true)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Computed version: ${VERSION:-'(nenhuma - usa env-sha)'} (branch: $BRANCH)"

      - name: Docker meta (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ steps.set-env.outputs.environment }}-

      - name: Docker meta (tags with semver)
        id: meta-semver
        if: steps.semver.outputs.version != ''
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}
          tags: |
            type=raw,value=${{ steps.semver.outputs.version }}
            type=ref,event=branch
            type=sha,prefix=${{ steps.set-env.outputs.environment }}-

      - name: Login GHCR (Docker)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Build e Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.semver.outputs.version != '' && steps.meta-semver.outputs.tags || steps.meta.outputs.tags }}
          labels: ${{ steps.semver.outputs.version != '' && steps.meta-semver.outputs.labels || steps.meta.outputs.labels }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login GHCR (Helm)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} \
            -u ${{ github.actor }} --password-stdin

      - name: Helm Package & Dependency Update
        id: package
        run: |
          cd helm-templates
          cd apps/${{ env.CHART_APP }} && helm dependency update && cd ../..
          mkdir -p dist
          BUILD_SOURCE_VERSION="${{ github.sha }}"
          BASE_VERSION=$(grep '^version:' apps/${{ env.CHART_APP }}/Chart.yaml | awk '{print $2}' | tr -d '"' | head -1)
          # Em main/release/develop usa versão semântica; senão env-sha (igual ao deploy para pull OCI)
          if [[ -n "${{ steps.semver.outputs.version }}" ]]; then
            NEW_TAG="${{ steps.semver.outputs.version }}"
          else
            NEW_TAG="${{ steps.set-env.outputs.environment }}-${GITHUB_SHA:0:7}"
          fi
          helm package apps/${{ env.CHART_APP }} -d dist \
            --app-version "$NEW_TAG" \
            --version "$NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "app_version=$NEW_TAG" >> $GITHUB_OUTPUT
          ########## validate path package #################
          ls -lha dist/
          ###################################################

      - name: Lint dos charts
        run: |
          cd helm-templates
          helm lint apps/${{ env.CHART_APP }}

      - name: Helm Push Repo (OCI)
        run: |
          cd helm-templates
          CHART_PATH=$(ls dist/*.tgz | head -1)
          CHART_NAME=$(basename "$CHART_PATH")
          echo "chartName=$CHART_NAME"
          OCI_REF="oci://${{ env.REGISTRY }}/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/helm-charts"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            helm push "$CHART_PATH" "$OCI_REF"
          fi

      - name: Create and push Git tag (semver) — apenas na branch release
        if: github.event_name == 'push' && startsWith(github.ref_name, 'release/') && steps.semver.outputs.version != ''
        run: |
          VERSION="${{ steps.semver.outputs.version }}"
          TAG_NAME="v${VERSION}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping push"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG_NAME" -m "Release $VERSION"
            git push origin "$TAG_NAME"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: helm-templates/dist
