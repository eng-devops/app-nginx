# Pipeline BUILD: imagem Docker + Helm package (app-version e version no momento do package)
# Triggers: push | pull_request em main, feature/*, release/*

name: Build

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'release/*'
  pull_request:
    branches:
      - main
      - 'release/*'

env:
  REGISTRY: ghcr.io
  HELM_TEMPLATES_REPO: eng-devops/helm-templates
  CHART_APP: nginx

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repos
        uses: actions/checkout@v4

      - name: Checkout helm-templates
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HELM_TEMPLATES_REPO }}
          path: helm-templates
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determined Environment
        id: set-env
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then ENV="prd"
          elif [[ "$BRANCH" =~ ^release/ ]]; then ENV="stg"
          elif [[ "$BRANCH" =~ ^feature/ ]]; then ENV="dev"
          else ENV="dev"; fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "namespace=$ENV" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH -> $ENV"

      - name: Docker meta (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ github.event.repository.name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ steps.set-env.outputs.environment }}-

      - name: Login GHCR (Docker)
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Build e Push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login GHCR (Helm)
        if: github.event_name == 'push'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} \
            -u ${{ github.actor }} --password-stdin

      - name: Helm Package & Dependency Update
        id: package
        run: |
          cd helm-templates
          cd apps/${{ env.CHART_APP }} && helm dependency update && cd ../..
          mkdir -p dist
          BUILD_SOURCE_VERSION="${{ github.sha }}"
          BASE_VERSION=$(grep '^version:' apps/${{ env.CHART_APP }}/Chart.yaml | awk '{print $2}' | tr -d '"' | head -1)
          NEW_TAG="${BASE_VERSION}-${GITHUB_SHA:0:7}"
          helm package apps/${{ env.CHART_APP }} -d dist \
            --app-version "$BUILD_SOURCE_VERSION" \
            --version "$NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "app_version=$BUILD_SOURCE_VERSION" >> $GITHUB_OUTPUT
          ########## validate path package #################
          ls -lha dist/
          ###################################################

      - name: Lint dos charts
        run: |
          cd helm-templates
          helm lint apps/${{ env.CHART_APP }}

      - name: Helm Push Repo (OCI)
        run: |
          cd helm-templates
          CHART_PATH=$(ls dist/*.tgz | head -1)
          CHART_NAME=$(basename "$CHART_PATH")
          echo "chartName=$CHART_NAME"
          OCI_REF="oci://${{ env.REGISTRY }}/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/helm-charts"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            helm push "$CHART_PATH" "$OCI_REF"
          fi
      - name: Upload artifact 
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: helm-templates/dist/*.tgz
